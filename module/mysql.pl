#====================================================================================================
#
#	MySQL関連モジュール
#	mysql.pl
#
#	---------------------------------------------------------------------------
#
#	2012.07.18 start
#
#====================================================================================================
package MySQL;

use strict;
use DBI;
use Config::Tiny;

#------------------------------------------------------------------------------------------------------------
#
#	モジュールコンストラクタ - new
#	-------------------------------------------
#	@param	なし
#	@return	モジュールオブジェクト
#
#------------------------------------------------------------------------------------------------------------
sub new
{
	my $this = shift;
	my $obj = {};
	my (%set);
	
	%set = undef;
	
	$obj = {
		'INI'		=> undef,		# 設定ファイルハンドル
		'SET'		=> \%set,		# ログイン関連情報
		'DBH'		=> undef,		# データベースハンドル
	};
	
	bless $obj, $this;
	
	return $obj;
}

#------------------------------------------------------------------------------------------------------------
#
#	ログイン関連情報セット
#	-------------------------------------------
#	@param	$ini		設定ファイル(ini)のパス
#	@return	なし
#
#------------------------------------------------------------------------------------------------------------
sub sqlSet
{
	my $this = shift;
	my ($ini) = @_;
	my ($config);
	
	$config = Config::Tiny->read($ini);
	$this->{'INI'} = $config;
	
	$this->{'SET'}->{'db'}		= $this->{'INI'}->{sql}->{'database'};		# データベース名
	$this->{'SET'}->{'server'}	= $this->{'INI'}->{sql}->{'server'};		# サーバー
	$this->{'SET'}->{'user'}	= $this->{'INI'}->{sql}->{'user'};			# ユーザID
	$this->{'SET'}->{'pass'}	= $this->{'INI'}->{sql}->{'pass'};			# パスワード
}

#------------------------------------------------------------------------------------------------------------
#
#	ログイン
#	-------------------------------------------
#	@param	なし
#	@return	成功すれば1 エラーであればNULL
#
#------------------------------------------------------------------------------------------------------------
sub sqlLogin
{
	my $this = shift;
	my ($set);
	my ($dbh, $set);
	
	$set = $this->{'SET'};
	
	$dbh = DBI->connect(
		join(':', 'DBI', 'mysql', $set->{'db'}, $set->{'server'}),
		$set->{'user'},
		$set->{'pass'},
	);
	
	if ( $dbh ne undef ) {
		$this->{'DBH'} = $dbh;
		return 1;
	}
	
	return undef;
}

#------------------------------------------------------------------------------------------------------------
#
#	接続解除
#	-------------------------------------------
#	@param	なし
#	@return	コマンド返答内容
#
#------------------------------------------------------------------------------------------------------------
sub end
{
	my $this = shift;
	
	$this->{'DBH'}->disconnect();
	
	return;
}

#------------------------------------------------------------------------------------------------------------
#
#	ユニークインデックスカラム識別
#	-------------------------------------------
#	@param	$table		テーブル
#			$column		カラム
#	@return	ユニークインデックスであれば1 そうでなければ0
#
#------------------------------------------------------------------------------------------------------------
sub IsUnique
{
	my $this = shift;
	my ($table, $column) = @_;
	
	# ユニークインデックスの変更をしたらファイルを更新してください
	foreach ( split(/,/,$this->{'INI'}->{$table}->{unique}) ) {
		if ( $_ eq $column ) {
			return 1;
		}
	}
	
	return 0;
}

#============================================================================================================
#	モジュール終端
#============================================================================================================
1;

__END__
=pod
この関数を良い感じにしてくれる人募集中
#------------------------------------------------------------------------------------------------------------
#
#	コマンド実行
#	-------------------------------------------
#	@param	$cmd	コマンド
#	@return	コマンド返答内容
#
#------------------------------------------------------------------------------------------------------------
sub cmdExec
{
	
	my $this = shift;
	my ($cmd) = @_;
	my ($sth);
	
	$sth = $this->{'DBH'}->prepare($cmd);
	$sth->execute;
	
	
	
}
=cut